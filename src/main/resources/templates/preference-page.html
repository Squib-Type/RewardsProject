<html layout:decorate="~{layout/bootstrap}">

<head>
	<title>Preference Summary</title>
</head>

<div layout:fragment="content">
	<table class="table table-hover">
		<thead>
			<tr><th>Stand Position</th><th>Number of Available Seats</th><th>Number of Preferred Seats</th><th>Discount Price per Ticket</th><th>Estimated Total Earnings</th></tr>
		</thead>
		<tbody id="summaryTable">
			<tr th:each="summary: ${summaries}">
			<td th:text="${summary.stand_id}">East</td>
			<td th:text="${summary.available_seats}">3</td>
			<td th:text="${summary.preferred_seats}">2</td>
			<td th:text="${#numbers.formatCurrency(summary.discount_price)}">$10.00</td>
			<td th:text="${#numbers.formatCurrency(summary.estimatedTotalEarnings)}">$20.00</td>
			</tr>
		</tbody>
	</table>
<div>
	<label for="firstName">First Name:</label>
	<input type="text" id="firstName" class="form-control" placeholder="John">
</div>

<div>
	<label for="lastName">Last Name:</label>
	<input type="text" id="lastName" class="form-control" placeholder="Doe">
</div>

<div>
	<label for="email">Email:</label>
	<input type="email" id="email" class="form-control" placeholder="johndoe@dummy.edu">
</div>

<div>
	<label for="phone">Phone Number:</label>
	<input type="text" id="phone" class="form-control" placeholder="xxx-xxxx-xxxx">
</div>
                
<div>
	<label for="firstOccupation">First Occupation:</label>
	<select id="firstOccupation" class="form-control">
		<option value="">-- Select --</option>
		<option value="STU">Student</option>
		<option value="EDU">Educator</option>
		<option value="MLT">Military</option>
		<option value="OTH">Others</option>
	</select>
</div>
                
<div>
	<label for="preferredStand">Preferred Stand Position:</label>
	<select id="preferredStand" class="form-control">
		<option value="">-- Select --</option>
		<option value="East">EAST</option>
		<option value="West">WEST</option>
		<option value="South">SOUTH</option>
		<option value="North">NORTH</option>
	</select>
</div>

<div>
	<label for="reservationTime">Reservation Time:</label>
	<input type="text" id="reservationTime" class="form-control" placeholder="yyyy-MM-dd HH:mm:ss.SSS (2024-04-11 08:00:12.234)">
</div>

<div>
	<input type="file" id="importFile" accept=".json" style="display:none;">
	<input type="file" id="importAppendFile" accept=".json" style="display:none;">
	
	<button onclick="openFileChooser()">Import</button>
	<button onclick="addPreference()">Add</button>
	<button onclick="openAppendFileChooser()">Import and Append</button>
	<button onclick="processRewards()">Reward</button>
</div>


<div id="importModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;">
	<div>
		<h2>Import Preview</h2>
		<table class="table">
			<thead>
				<tr>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Email</th>
					<th>Phone</th>
					<th>First Occupation</th>
					<th>Preferred Stand</th>
					<th>Reservation Time</th>
				</tr>
			</thead>
			<tbody id="previewTable">
			</tbody>
		</table>
		<button onclick="submitImport()">Submit</button>
	</div>
</div>
<script>

	let importedData = [];
		document.getElementById('importFile').addEventListener('change', function(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const jsonData = JSON.parse(e.target.result);
					validateAndPreviewImport(jsonData);
				};
				reader.readAsText(file);
			}
		});

		function openFileChooser() {
			document.getElementById('importFile').click();
		}
		
		document.getElementById('importAppendFile').addEventListener('change', function(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const jsonData = JSON.parse(e.target.result);
					importAndAppend(jsonData);
				};
				reader.readAsText(file);
			}
		});
		
		function openAppendFileChooser() {
			document.getElementById('importAppendFile').click();
		}

		function validateAndPreviewImport(jsonData) {
			fetch('/api/import', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(jsonData)
			})
			.then(response => response.json())
			.then(data => {
				if (data.success && data.preview) {
					importedData = jsonData;
					showImportModal(data.data);
				} else {
					alert(data.message || 'Import failed');
				}
			});
		}
		
		function importAndAppend(jsonData) {
			fetch('/api/import-append', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(jsonData)
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					alert(data.message);
					document.getElementById('importAppendFile').value = '';
					updateSummaryTable();
				} else {
					alert(data.message || 'Import and append failed');
				}
			});
		}

		function showImportModal(preferences) {
			const tbody = document.getElementById('previewTable');
			tbody.innerHTML = '';
			
			preferences.forEach(pref => {
				const row = tbody.insertRow();
				row.insertCell(0).textContent = pref.first_name;
				row.insertCell(1).textContent = pref.last_name;
				row.insertCell(2).textContent = pref.email;
				row.insertCell(3).textContent = pref.phone;
				row.insertCell(4).textContent = pref.first_occupation;
				row.insertCell(5).textContent = pref.stand_id;
				row.insertCell(6).textContent = pref.reservation_time;
			});
			
			document.getElementById('importModal').style.display = 'block';
		}

		function closeModal() {
			document.getElementById('importModal').style.display = 'none';
			document.getElementById('importFile').value = '';
			importedData = [];
		}

		function submitImport() {
			fetch('/api/import?confirm=true', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(importedData)
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					alert(data.message);
					closeModal();
					updateSummaryTable();
				} else {
					alert(data.message || 'Import failed');
				}
			});
		}

		function addPreference() {
			const preference = {
				firstName: document.getElementById('firstName').value,
				lastName: document.getElementById('lastName').value,
				email: document.getElementById('email').value,
				phone: document.getElementById('phone').value,
				firstOccupation: document.getElementById('firstOccupation').value,
				preferredStand: document.getElementById('preferredStand').value,
				reservationTime: document.getElementById('reservationTime').value
			};
			fetch('/api/add', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(preference)
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					alert(data.message);
					clearForm();
					updateSummaryTable();
				} else {
					alert(data.message || 'Import failed');
				}
			});
		}

		function updateSummaryTable() {
			fetch('/api/summary')
			.then(response => response.json())
			.then(summaries => {
				const tbody = document.getElementById('summaryTable');
				tbody.innerHTML = '';
				summaries.forEach(summary => {
					const row = tbody.insertRow();
					row.insertCell(0).textContent = summary.stand_id;
					row.insertCell(1).textContent = summary.available_seats;
					row.insertCell(2).textContent = summary.preferred_seats;
					row.insertCell(3).textContent = '$' + summary.discount_price.toFixed(2);
					row.insertCell(4).textContent = '$' + summary.estimatedTotalEarnings.toFixed(2);
				});
			});
		}
		
		function clearForm() {
			document.getElementById('firstName').value = '';
			document.getElementById('lastName').value = '';
			document.getElementById('email').value = '';
			document.getElementById('phone').value = '';
			document.getElementById('firstOccupation').value = '';
			document.getElementById('preferredStand').value = '';
			document.getElementById('reservationTime').value = '';
		}
		
		function processRewards() {
		    fetch('/reward/process', {
		        method: 'POST',
		        headers: {'Content-Type': 'application/json'}
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.success) {
		            window.location.href = '/reward-results';
		        } else {
		            alert('Error: ' + data.message);
		        }
		    })
		    .catch(error => {
		        console.error('Fetch error:', error);
		        alert('Error processing rewards: ' + error);
		    });
		}

</script>
</div>
</html>